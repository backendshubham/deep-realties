<%- include('../layouts/main', { content: `
<style>
    .property-image-carousel {
        position: relative;
    }
    
    .carousel-container {
        position: relative;
    }
    
    .carousel-wrapper {
        display: flex;
        width: 100%;
        transition: transform 0.3s ease-in-out;
    }
    
    .carousel-slide {
        min-width: 100%;
        flex-shrink: 0;
        display: block;
    }
    
    .carousel-btn {
        z-index: 10;
        opacity: 0.9;
    }
    
    .carousel-btn:hover {
        opacity: 1;
    }
    
    .carousel-indicator {
        cursor: pointer;
    }
    
    .thumbnail-item {
        cursor: pointer;
        transition: opacity 0.2s;
    }
    
    .thumbnail-item:hover {
        opacity: 0.8;
    }
    
    .thumbnail-item.active img {
        border-color: #10b981 !important;
    }
</style>

<div class="min-h-screen py-6 sm:py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="propertyDetails" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6 lg:p-8 border border-gray-200 dark:border-gray-700">
            <p class="text-center text-gray-600 dark:text-gray-400 text-sm sm:text-base">Loading property details...</p>
        </div>
    </div>
</div>

<script>
    async function loadPropertyDetails() {
        // Get propertyId from URL path
        const pathParts = window.location.pathname.split('/');
        const propertyId = pathParts[pathParts.length - 1];
        
        const container = document.getElementById('propertyDetails');
        const response = await fetch('/api/properties/' + propertyId);
        const data = await response.json();
        
        // Get current user info to check if they own this property
        let currentUserId = null;
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const userResponse = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    currentUserId = userData.user?.id || null;
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }
        
        // Simple placeholder image as data URI (SVG) - using double quotes to avoid syntax errors
        const placeholderImage = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2218%22 fill=%22%239ca3af%22%3ENo Image%3C/text%3E%3C/svg%3E';
        
        if (data.property) {
            const p = data.property;
            const images = (p.images && p.images.length > 0) ? p.images : [placeholderImage];
            const bedroomsHtml = p.bedrooms ? '<div class="p-3 sm:p-4 bg-gray-50 dark:bg-gray-600 rounded-lg"><p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-1">Bedrooms</p><p class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white">' + p.bedrooms + '</p></div>' : '';
            const bathroomsHtml = p.bathrooms ? '<div class="p-3 sm:p-4 bg-gray-50 dark:bg-gray-600 rounded-lg"><p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-1">Bathrooms</p><p class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white">' + p.bathrooms + '</p></div>' : '';
            const description = p.description || 'No description available';
            
            // Check if current user is the owner
            const isOwner = currentUserId && p.seller_id && currentUserId === p.seller_id;
            
            // Generate button HTML based on ownership
            let buttonHtml = '';
            if (isOwner) {
                buttonHtml = '<div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-4 text-center">' +
                    '<p class="text-sm text-emerald-700 dark:text-emerald-300 font-medium mb-2">This is your property</p>' +
                    '<a href="/my-properties" class="button-text inline-block px-4 sm:px-6 py-2 sm:py-2.5 text-sm sm:text-base bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors">' +
                        'Manage Property' +
                    '</a>' +
                    '</div>';
            } else {
                buttonHtml = '<button onclick="showEnquiryForm()" class="button-text w-full px-4 sm:px-6 py-2.5 sm:py-3 text-sm sm:text-base bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors">' +
                    'Enquire Now' +
                    '</button>';
            }
            
            // Generate image carousel HTML
            let carouselHtml = '';
            if (images.length > 0) {
                const imageItems = images.map((img, index) => {
                    return '<div class="carousel-slide' + (index === 0 ? ' active' : '') + '" data-slide="' + index + '">' +
                        '<img src="' + img + '" alt="' + p.title + ' - Image ' + (index + 1) + '" class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg">' +
                        '</div>';
                }).join('');
                
                const thumbnailItems = images.map((img, index) => {
                    return '<div class="thumbnail-item' + (index === 0 ? ' active' : '') + '" data-slide="' + index + '">' +
                        '<img src="' + img + '" alt="Thumbnail ' + (index + 1) + '" class="w-full h-16 sm:h-20 object-cover rounded cursor-pointer border-2' + (index === 0 ? ' border-emerald-500' : ' border-transparent') + ' hover:border-emerald-400 transition-all">' +
                        '</div>';
                }).join('');
                
                carouselHtml = '<div class="property-image-carousel relative">' +
                    '<div class="carousel-container relative rounded-lg mb-4 overflow-hidden" style="width: 100%;">' +
                        '<div class="carousel-wrapper">' +
                            imageItems +
                        '</div>' +
                        (images.length > 1 ? '<button class="carousel-btn carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-white dark:bg-gray-800 text-gray-800 dark:text-white p-2 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none" aria-label="Previous image">' +
                            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>' +
                        '</button>' +
                        '<button class="carousel-btn carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-white dark:bg-gray-800 text-gray-800 dark:text-white p-2 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none" aria-label="Next image">' +
                            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' +
                        '</button>' : '') +
                        (images.length > 1 ? '<div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">' +
                            images.map((img, index) => {
                                return '<button class="carousel-indicator w-2 h-2 rounded-full' + (index === 0 ? ' bg-white' : ' bg-white/50') + ' transition-all" data-slide="' + index + '" aria-label="Go to slide ' + (index + 1) + '"></button>';
                            }).join('') +
                        '</div>' : '') +
                    '</div>' +
                    (images.length > 1 ? '<div class="thumbnail-container grid grid-cols-4 sm:grid-cols-5 gap-2">' +
                        thumbnailItems +
                    '</div>' : '') +
                '</div>';
            } else {
                carouselHtml = '<img src="' + placeholderImage + '" alt="' + p.title + '" class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg">';
            }
            
            container.innerHTML = 
                '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">' +
                    '<div>' +
                        carouselHtml +
                    '</div>' +
                    '<div>' +
                        '<h1 class="section-title text-2xl sm:text-3xl mb-3 sm:mb-4 text-gray-900 dark:text-white">' + p.title + '</h1>' +
                        '<p class="text-lg sm:text-xl text-emerald-600 dark:text-emerald-400 font-bold mb-4 sm:mb-6">' +
                            'â‚¹' + p.price.toLocaleString() +
                        '</p>' +
                        '<div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">' +
                            '<div class="p-3 sm:p-4 bg-gray-50 dark:bg-gray-600 rounded-lg">' +
                                '<p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-1">Area</p>' +
                                '<p class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white">' + p.area_sqft + ' sqft</p>' +
                            '</div>' +
                            '<div class="p-3 sm:p-4 bg-gray-50 dark:bg-gray-600 rounded-lg">' +
                                '<p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-1">Type</p>' +
                                '<p class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white capitalize">' + p.property_type + '</p>' +
                            '</div>' +
                            bedroomsHtml +
                            bathroomsHtml +
                        '</div>' +
                        '<p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-4">' +
                            '<strong class="text-gray-900 dark:text-white">Location:</strong> ' + p.locality + ', ' + p.city + ', ' + p.state +
                        '</p>' +
                        '<p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-6 leading-relaxed">' + description + '</p>' +
                        buttonHtml +
                    '</div>' +
                '</div>';
            
            // Initialize carousel if images exist
            if (images.length > 1) {
                initializeCarousel();
            }
        } else {
            container.innerHTML = '<p class="text-center text-red-600">Property not found</p>';
        }
    }
    
    function showEnquiryForm() {
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        // Show enquiry form modal
        showInfo('Enquiry form will be implemented soon');
    }
    
    let currentSlide = 0;
    let totalSlides = 0;
    
    function initializeCarousel() {
        const carousel = document.querySelector('.property-image-carousel');
        if (!carousel) return;
        
        const slides = carousel.querySelectorAll('.carousel-slide');
        const thumbnails = carousel.querySelectorAll('.thumbnail-item');
        const indicators = carousel.querySelectorAll('.carousel-indicator');
        const prevBtn = carousel.querySelector('.carousel-prev');
        const nextBtn = carousel.querySelector('.carousel-next');
        const wrapper = carousel.querySelector('.carousel-wrapper');
        
        totalSlides = slides.length;
        currentSlide = 0;
        
        // Initialize carousel position
        if (wrapper) {
            wrapper.style.transform = 'translateX(0%)';
        }
        
        function updateCarousel() {
            // Update main image - move wrapper to show current slide
            if (wrapper) {
                wrapper.style.transform = 'translateX(-' + (currentSlide * 100) + '%)';
            }
            
            // Update thumbnails
            thumbnails.forEach((thumb, index) => {
                if (index === currentSlide) {
                    thumb.classList.add('active');
                    thumb.querySelector('img').classList.add('border-emerald-500');
                    thumb.querySelector('img').classList.remove('border-transparent');
                } else {
                    thumb.classList.remove('active');
                    thumb.querySelector('img').classList.remove('border-emerald-500');
                    thumb.querySelector('img').classList.add('border-transparent');
                }
            });
            
            // Update indicators
            indicators.forEach((indicator, index) => {
                if (index === currentSlide) {
                    indicator.classList.add('bg-white');
                    indicator.classList.remove('bg-white/50');
                } else {
                    indicator.classList.remove('bg-white');
                    indicator.classList.add('bg-white/50');
                }
            });
        }
        
        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            updateCarousel();
        }
        
        function prevSlide() {
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            updateCarousel();
        }
        
        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
        }
        
        if (nextBtn) nextBtn.addEventListener('click', nextSlide);
        if (prevBtn) prevBtn.addEventListener('click', prevSlide);
        
        thumbnails.forEach((thumb, index) => {
            thumb.addEventListener('click', () => goToSlide(index));
        });
        
        indicators.forEach((indicator, index) => {
            indicator.addEventListener('click', () => goToSlide(index));
        });
        
        // Initialize carousel to show first slide
        updateCarousel();
        
        // Auto-play carousel (optional - can be removed if not needed)
        // let autoPlayInterval = setInterval(nextSlide, 5000);
        // carousel.addEventListener('mouseenter', () => clearInterval(autoPlayInterval));
        // carousel.addEventListener('mouseleave', () => {
        //     autoPlayInterval = setInterval(nextSlide, 5000);
        // });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        loadPropertyDetails();
    });
</script>
` }) %>

